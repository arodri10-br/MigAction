
{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="mb-4">usuario</h1>
</div>
<div class="toolbar">
    <button onclick="showAddModal()" class="primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Novo
    </button>
    <button onclick="editSelected()" class="primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
        Editar
    </button>
    <button onclick="deleteSelected()" class="secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        Excluir
    </button>
</div>

<div class="grid-container">
    <table class="grid">
        <thead>
            <tr>
                <th class="radio-cell"></th>
                <th>username</th>
                <th>nome</th>
                <th>email</th>
                <th>perfil</th>
                <th>status</th>
                <th>passw_encrypted</th>
            </tr>
        </thead>
        <tbody id="usuarioTable">
            <!-- Preenchido dinamicamente -->
        </tbody>
    </table>
</div>

<!-- Modal de Formulário -->
<div id="formModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Novo "usuario"</h2>
        <form id="usuarioForm">
            
            <div class="form-group">
                <label for="username">id Usuario:</label>
                <input type="text" id="username" name="username" >
            </div>
        

            <div class="form-group">
                <label for="nome">Nome Completo:</label>
                <input type="text" id="nome" name="nome" >
            </div>
        

            <div class="form-group">
                <label for="email">Email:</label>
                <input type="text" id="email" name="email" >
            </div>
        

            <div class="form-group">
                <label for="perfil">Perfil:</label>
                <input type="text" id="perfil" name="perfil" >
            </div>
        

            <div class="form-group">
                <label for="status">Status:</label>
                <input type="text" id="status" name="status" >
            </div>
        

            <div class="form-group">
                <label for="passw_encrypted">passw_encrypted:</label>
                <input type="text" id="passw_encrypted" name="passw_encrypted" >
            </div>
        
            <div class="modal-actions">
                <button type="button" class="secondary" onclick="hideModal()">Cancelar</button>
                <button type="submit" class="primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadusuario();
    });
    function loadusuario() {
        fetch('/api/usuario/')
            .then(response => response.json())
            .then(data => {
                const usuarioTable = document.getElementById('usuarioTable');
                usuarioTable.innerHTML = '';
                data.forEach(user => {
                    const row = usuarioTable.insertRow();
                    const radioCell = row.insertCell();
                    radioCell.className = 'radio-cell';
                    radioCell.innerHTML = `<input type="radio" name="selectedUser" value="${usuario.username}">`;
                    row.insertCell().innerText = usuario.username;
                    row.insertCell().innerText = usuario.nome;
                    row.insertCell().innerText = usuario.email;
                    row.insertCell().innerText = usuario.perfil;
                    row.insertCell().innerText = usuario.status;
                    row.insertCell().innerText = usuario.passw_encrypted;

                });
            });
    }
    

    function showAddModal() {
        document.getElementById('modalTitle').textContent = 'Novo usuario';
        document.getElementById('usuarioForm').reset();
        document.getElementById('username').value = '';
        document.getElementById('formModal').classList.add('active');
        document.getElementById('username').readOnly = false; // Permitir edicao na inclusao

    }
    
    function hideModal() {
        document.getElementById('formModal').classList.remove('active');
    }

    function getSelected(usuario) {
        const selected = document.querySelector('input[name="selectedusuario"]:checked');
        return selected ? selected.value : null;
    }

    function editSelected() {
        const usuario = getSelectedusuario();
        if (!{table_name}) {
            alert('Por favor, selecione um usuario para editar.');
            return;
        }

        fetch(`/api/usuario/${usuario}`)
            .then(response => response.json())
            .then(user => {
                document.getElementById('modalTitle').textContent = 'Editar usuario';
                document.getElementById("username").value = usuario.username;
                document.getElementById("nome").value = usuario.nome;
                document.getElementById("email").value = usuario.email;
                document.getElementById("perfil").value = usuario.perfil;
                document.getElementById("status").value = usuario.status;
                document.getElementById("passw_encrypted").value = usuario.passw_encrypted;

                document.getElementById('username').readOnly = true; // Bloquear edicao

            });
    }

    function deleteSelected() {
        const usuario = getSelectedusuario();
        if (!usuario) {
            alert('Por favor, selecione um usuario para excluir.');
            return;
        }

        if (confirm('Tem certeza que deseja excluir este usuario?')) {
            fetch(`/api/usuario/${usuario}`, {
                method: 'DELETE'
            }).then(() => {
                loadusuario();
            });
        }
    }
       
    document.getElementById('usuarioForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const usuario = document.getElementById('username').value;
        const isEdit = document.getElementById('username').readOnly;  // Se readOnly, é edição
        const method = isEdit ? 'PUT' : 'POST';
        const url = isEdit ? `/api/usuario/${usuario}` : '/api/usuario/';
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => response.json())
        .then(() => {
            hideModal();
            loadusuario();
        });
    });
</script>

{% endblock %}
