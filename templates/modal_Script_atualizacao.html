<div id="formModalAtualizacao" class="modal">
  <div class="modal-content">
    <h2>Atualização</h2>
    <form id="atualizacaoForm">
      <!-- ComboBox DataSource -->
      <div class="form-group">
         <label for="datasourceAtualizacao">Data Source:</label>
         <select id="datasourceAtualizacao" name="datasource" class="form-control">
            <option value="">Selecione...</option>
         </select>
      </div>
      <!-- Campo para Código SQL -->
      <div class="form-group">
         <label for="sqlCodeAtualizacao">Código SQL:</label>
         <textarea id="sqlCodeAtualizacao" name="sqlCode" class="form-control" rows="5" placeholder="Digite sua query SQL aqui..."></textarea>
      </div>
      <!-- Tabela Oculta para Resultados da Consulta -->
      <div id="queryResultsContainerAtualizacao" style="display:none; margin-top:20px;">
         <h4>Resultados da Consulta</h4>
         <table class="table table-bordered">
            <thead id="queryResultsHeaderAtualizacao">
               <!-- Cabeçalho inserido via JavaScript -->
            </thead>
            <tbody id="queryResultsBodyAtualizacao">
               <!-- Dados inseridos via JavaScript -->
            </tbody>
         </table>
         <!-- Controles de Paginação -->
         <div class="pagination">
             <button type="button" id="prevPageAtualizacao" class="btn btn-secondary" onclick="prevPageAtualizacao()">Anterior</button>
             <span id="pageIndicatorAtualizacao">1</span>
             <button type="button" id="nextPageAtualizacao" class="btn btn-secondary" onclick="nextPageAtualizacao()">Próximo</button>
         </div>
      </div>
      <!-- Toolbox com botões -->
      <div class="toolbox" style="margin-top: 20px;">
         <button type="button" class="btn btn-success" onclick="validateSQLAtualizacao()">Validar</button>
         <button type="button" class="btn btn-primary" onclick="saveAtualizacao()">Salvar</button>
         <button type="button" class="btn btn-secondary" onclick="cancelAtualizacao()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
// Ao carregar o modal, popula o combo box DataSource para Atualização
document.addEventListener('DOMContentLoaded', function(){
  fetch('http://127.0.0.1:5000/api/datasource/')
    .then(response => response.json())
    .then(data => {
       const datasourceSelect = document.getElementById('datasourceAtualizacao');
       data.forEach(item => {
         let option = document.createElement('option');
         option.value = item.idDataSource;
         option.text = item.dsDataSource;
         datasourceSelect.appendChild(option);
       });
    })
    .catch(error => console.error('Erro ao carregar DataSource:', error));
});

let currentPageAtualizacao = 1;

function validateSQLAtualizacao(){
   const datasource = document.getElementById('datasourceAtualizacao').value;
   const sqlCode = document.getElementById('sqlCodeAtualizacao').value.trim();
   if (!datasource) {
      alert('Por favor, selecione um Data Source.');
      return;
   }
   if (!sqlCode) {
      alert('Por favor, informe o código SQL.');
      return;
   }
   // Chamada à API que valida e executa a query (mesmo endpoint pode ser utilizado)
   fetch('/api/validateSQL', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       datasource: datasource,
       sql: sqlCode,
       page: currentPageAtualizacao
     })
   })
   .then(response => response.json())
   .then(result => {
       const resultsContainer = document.getElementById('queryResultsContainerAtualizacao');
       const header = document.getElementById('queryResultsHeaderAtualizacao');
       const body = document.getElementById('queryResultsBodyAtualizacao');
       header.innerHTML = '';
       body.innerHTML = '';
       
       if (result.headers && result.headers.length > 0) {
         let headerRow = document.createElement('tr');
         result.headers.forEach(col => {
           let th = document.createElement('th');
           th.textContent = col;
           headerRow.appendChild(th);
         });
         header.appendChild(headerRow);
       }
       
       if (result.rows && result.rows.length > 0) {
         result.rows.forEach(row => {
           let tr = document.createElement('tr');
           row.forEach(cell => {
             let td = document.createElement('td');
             td.textContent = cell;
             tr.appendChild(td);
           });
           body.appendChild(tr);
         });
       } else {
         let tr = document.createElement('tr');
         let td = document.createElement('td');
         td.colSpan = result.headers ? result.headers.length : 1;
         td.textContent = 'Nenhum dado encontrado.';
         tr.appendChild(td);
         body.appendChild(tr);
       }
       
       resultsContainer.style.display = 'block';
       document.getElementById('pageIndicatorAtualizacao').textContent = currentPageAtualizacao;
   })
   .catch(error => {
       console.error('Erro ao validar SQL:', error);
       alert('Erro ao validar SQL.');
   });
}

function prevPageAtualizacao(){
  if (currentPageAtualizacao > 1) {
    currentPageAtualizacao--;
    validateSQLAtualizacao();
  }
}

function nextPageAtualizacao(){
  currentPageAtualizacao++;
  validateSQLAtualizacao();
}

// Função para salvar os dados (atualizar script.cmdInsert)
function saveAtualizacao(){
   const datasource = document.getElementById('datasourceAtualizacao').value;
   const sqlCode = document.getElementById('sqlCodeAtualizacao').value.trim();
   if (!datasource || !sqlCode) {
      alert('Preencha todos os campos antes de salvar.');
      return;
   }
   // Chamada à API para atualizar o campo cmdInsert do script.
   fetch('/api/script/cmdInsert', {
     method: 'PUT',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       datasource: datasource,
       sql: sqlCode
     })
   })
   .then(response => {
       if (response.ok) {
         alert('Dados salvos com sucesso.');
         cancelAtualizacao();
       } else {
         alert('Erro ao salvar dados.');
       }
   })
   .catch(error => {
     console.error('Erro:', error);
     alert('Erro ao salvar dados.');
   });
}

function cancelAtualizacao(){
   document.getElementById('atualizacaoForm').reset();
   document.getElementById('queryResultsContainerAtualizacao').style.display = 'none';
   document.getElementById('formModalAtualizacao').style.display = 'none';
}
</script>
