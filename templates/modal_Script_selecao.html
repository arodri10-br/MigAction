<!-- Dependências do CodeMirror (certifique-se de incluí-las no seu template base ou nesta página) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/eclipse.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/sql/sql.min.js"></script>

<!-- Modal de Seleção -->
<div id="formModalSelecao" class="modal">
  <div class="modal-content" style="width: 90%; max-width: 1200px; margin: auto;">
    <h2>Seleção</h2>
    <form id="selecaoForm">
      <!-- ComboBox DataSource -->
      <div class="form-group" style="width: 50%;">
         <label for="datasource">Data Source:</label>
         <select id="datasource" name="datasource" class="form-control">
            <option value="">Selecione...</option>
         </select>
         <label for="Campo2Update">Data Source:</label>
         <select id="Campo2Update" name="Campo2Update" class="form-control">
          <option value="">Selecione...</option>
          <option value="1">Seleção</option>
          <option value="2">Atualização</option>
          <script>
            document.getElementById('Campo2Update').addEventListener('change', function() {
              const selectedValue = this.value;

              /*

              Aqui tem que definir o idProjeto, ordem e seq conforme a lógica da sua aplicação, vou mudar o botão para a toolbar e usar o Key.

              */
              const idProjeto = '1'; 
              const ordem = '1'; 
              const seq = '1'; 

              if (selectedValue === '1' || selectedValue === '2') {
                fetch(`/api/script/${idProjeto}/${ordem}/${seq}`)
                  .then(response => response.json())
                  .then(data => {
                    if (selectedValue === '1') {
                      sqlEditor.setValue(data.selDados || '');
                    } else if (selectedValue === '2') {
                      sqlEditor.setValue(data.cmdInsert || '');
                    }
                  })
                  .catch(error => console.error('Erro ao carregar dados:', error));
              } else {
                sqlEditor.setValue('');
              }
            });
          </script>
        </select>
      </div>
      
      <!-- Campo para Código SQL com CodeMirror -->
      <!-- O textarea fica oculto e o CodeMirror é renderizado no div com largura fixa -->
      <div class="form-group" style="width: 100%;">
         <textarea id="sqlCode" name="sqlCode" style="display: none;"></textarea>
         <!-- Aqui definimos uma largura fixa (800px) para o editor -->
         <div id="sqlEditor" style="border: 1px solid #ccc; height: 300px; width: 1200px;"></div>
      </div>
      
      <!-- Tabela Oculta para Resultados da Consulta -->
      <div id="queryResultsContainer" style="display:none; margin-top:20px;">
         <h4>Resultados da Consulta</h4>
         <table class="table table-bordered">
            <thead id="queryResultsHeader">
               <!-- Cabeçalho inserido via JavaScript -->
            </thead>
            <tbody id="queryResultsBody">
               <!-- Dados inseridos via JavaScript -->
            </tbody>
         </table>
         <!-- Controles de Paginação -->
         <div class="pagination">
             <button type="button" id="prevPage" class="btn btn-secondary" onclick="prevPageSelecao()">Anterior</button>
             <span id="pageIndicatorSelecao">1</span>
             <button type="button" id="nextPage" class="btn btn-secondary" onclick="nextPageSelecao()">Próximo</button>
         </div>
      </div>
      
      <!-- Toolbox com botões -->
      <div class="toolbox" style="margin-top: 20px;">
         <button type="button" class="btn btn-success" onclick="validateSQLSelecao()">Validar</button>
         <button type="button" class="btn btn-primary" onclick="saveSelecao()">Salvar</button>
         <button type="button" class="btn btn-secondary" onclick="cancelSelecao()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Declaração global para uso do editor nas funções
  var sqlEditor;

  document.addEventListener('DOMContentLoaded', function(){
    // Inicializa o CodeMirror no container #sqlEditor
    sqlEditor = CodeMirror(document.getElementById('sqlEditor'), {
      value: "",
      mode: "text/x-sql",
      theme: "eclipse",
      lineNumbers: true,
      viewportMargin: Infinity,
      indentWithTabs: true,
      smartIndent: true,
      matchBrackets: true,
      autofocus: true,
      lineWrapping: true  // Ativa a quebra de linha para manter a largura fixa
    });
    
    // Popula o combo box DataSource
    fetch('/api/datasource/')
      .then(response => response.json())
      .then(data => {
         const datasourceSelect = document.getElementById('datasource');
         data.forEach(item => {
           let option = document.createElement('option');
           option.value = item.idDataSource;
           option.text = item.dsDataSource;
           datasourceSelect.appendChild(option);
         });
      })
      .catch(error => console.error('Erro ao carregar DataSource:', error));
  });
  
  let currentPageSelecao = 1;
  
  // Função para validar a query SQL (ao clicar em "Validar")
  function validateSQLSelecao(){
     const idDataSource = document.getElementById('datasource').value;
     const sqlCode = sqlEditor.getValue().trim();
     if (!datasource) {
        alert('Por favor, selecione um Data Source.');
        return;
     }
     if (!sqlCode) {
        alert('Por favor, informe o código SQL.');
        return;
     }
     // Chamada à API para validar e executar a query
     fetch('/api/script/validateSQL', {
       method: 'PUT',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({
         idDataSource: idDataSource,
         sql: sqlCode,
         page: currentPageSelecao
       })
     })
     .then(response => response.json())
     .then(result => {
         // Exibe os resultados na tabela
         const resultsContainer = document.getElementById('queryResultsContainer');
         const header = document.getElementById('queryResultsHeader');
         const body = document.getElementById('queryResultsBody');
         header.innerHTML = '';
         body.innerHTML = '';
         
         if (result.headers && result.headers.length > 0) {
           let headerRow = document.createElement('tr');
           result.headers.forEach(col => {
             let th = document.createElement('th');
             th.textContent = col;
             headerRow.appendChild(th);
           });
           header.appendChild(headerRow);
         }
         
         if (result.rows && result.rows.length > 0) {
           result.rows.forEach(row => {
             let tr = document.createElement('tr');
             row.forEach(cell => {
               let td = document.createElement('td');
               td.textContent = cell;
               tr.appendChild(td);
             });
             body.appendChild(tr);
           });
         } else {
           let tr = document.createElement('tr');
           let td = document.createElement('td');
           td.colSpan = result.headers ? result.headers.length : 1;
           td.textContent = 'Nenhum dado encontrado.';
           tr.appendChild(td);
           body.appendChild(tr);
         }
         
         resultsContainer.style.display = 'block';
         document.getElementById('pageIndicatorSelecao').textContent = currentPageSelecao;
     })
     .catch(error => {
         console.error('Erro ao validar SQL:', error);
         alert('Erro ao validar SQL.');
     });
  }
  
  function prevPageSelecao(){
    if (currentPageSelecao > 1) {
      currentPageSelecao--;
      validateSQLSelecao();
    }
  }
  
  function nextPageSelecao(){
    currentPageSelecao++;
    validateSQLSelecao();
  }
  
  // Função para salvar os dados (atualizar script.selDados)
  function saveSelecao(){
     const datasource = document.getElementById('datasource').value;
     const sqlCode = sqlEditor.getValue().trim();
     if (!datasource || !sqlCode) {
        alert('Preencha todos os campos antes de salvar.');
        return;
     }
     // Chamada à API para salvar os dados no campo selDados do script
     // /api/script/<string:idProjeto>/<string:ordem>/<string:seq>
     fetch('/api/script/selDados', {
       method: 'PUT',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({
         datasource: datasource,
         sql: sqlCode
       })
     })
     .then(response => {
         if (response.ok) {
           alert('Dados salvos com sucesso.');
           cancelSelecao();
         } else {
           alert('Erro ao salvar dados.');
         }
     })
     .catch(error => {
       console.error('Erro:', error);
       alert('Erro ao salvar dados.');
     });
  }
  
  // Função para cancelar (fechar/limpar o modal)
  function cancelSelecao(){
     document.getElementById('selecaoForm').reset();
     sqlEditor.setValue("");
     document.getElementById('queryResultsContainer').style.display = 'none';
     // Adapte o fechamento do modal conforme sua lógica de exibição
     document.getElementById('formModalSelecao').style.display = 'none';
  }
</script>
